---
import jwt from 'jsonwebtoken';
import ReaderLayout from '../../../layouts/ReaderLayout.astro';
import { getAllChapters } from '../../../lib/chapters';

const PREVIEW_TOKEN = import.meta.env.PREVIEW_TOKEN;
const JWT_SECRET = import.meta.env.JWT_SECRET;

function isAuthorized(request: Request): boolean {
  if (!PREVIEW_TOKEN || !JWT_SECRET) return false;

  const url = new URL(request.url);
  const token = url.searchParams.get('token');
  if (token === PREVIEW_TOKEN) return true;

  const cookies = request.headers.get('cookie') ?? '';
  const match = cookies.match(/dotd-preview=([^;]+)/);
  if (match) {
    try {
      jwt.verify(match[1], JWT_SECRET);
      return true;
    } catch { /* invalid */ }
  }

  return false;
}

if (!isAuthorized(Astro.request)) {
  return Astro.redirect('/preview/login');
}

// Set preview cookie if authenticating via token param
const url = new URL(Astro.request.url);
const setCookie = url.searchParams.has('token');
if (setCookie) {
  const cookieValue = jwt.sign({ preview: true }, JWT_SECRET!, { expiresIn: '24h' });
  Astro.cookies.set('dotd-preview', cookieValue, {
    httpOnly: true,
    secure: true,
    sameSite: 'lax',
    maxAge: 86400,
    path: '/preview',
  });
}

const bookSlug = 'the-outer-tokens';
const chapters = await getAllChapters(bookSlug);
---

<ReaderLayout title="[Preview] The Outer Tokens" description="Preview â€” all chapters including drafts.">
  <div class="page contents-page" data-book-slug={bookSlug}>
    <div class="preview-banner">Draft Preview</div>
    <h1 class="book-title">The Outer Tokens</h1>
    <p class="book-subtitle">In the Beginning Was the Word</p>

    <nav class="toc">
      <ol class="toc-list">
        {chapters.map((entry) => {
          const label = entry.data.chapter === 0 ? '' : `Chapter ${entry.data.chapter}`;
          const isDraft = entry.data.status === 'draft';
          return (
            <li>
              <a href={`/preview/${bookSlug}/${entry.slug}`}>
                <span class="toc-chapter-number">
                  {label}
                  {isDraft && <span class="toc-draft-badge">draft</span>}
                </span>
                <span class="toc-chapter-title">{entry.data.title}</span>
              </a>
            </li>
          );
        })}
      </ol>
    </nav>
    <div class="toc-home"><a href="/">&larr; Home</a></div>
  </div>
</ReaderLayout>
