const z="dotd:progress:",P="dotd:reader-settings";let c=0,a=1,g=0,p=null,A=0,x=0,d,s,F,y,v,b,h,M,I;function D(){const t=document.querySelector(".chapter-body p");return t&&parseFloat(getComputedStyle(t).lineHeight)||32.76}function X(t,e){return Math.floor(t/e)*e}function _(){const e=document.getElementById("page-indicator")?.offsetHeight??52,n=document.getElementById("running-header"),r=n?n.offsetHeight:0,o=document.getElementById("reader"),i=getComputedStyle(o),u=parseFloat(i.paddingTop),w=window.innerHeight-u-e-r,C=D(),H=X(w,C);d.style.height=H+"px",d.style.flex="none",g=d.clientWidth,s.style.columnWidth=g+"px"}function L(){const t=s.scrollWidth;a=Math.max(1,Math.round((t+80)/(g+80)))}function l(t,e=!0){c=Math.max(0,Math.min(t,a-1));const n=-(c*(g+80));if(s.style.transform=`translateX(${n}px)`,F.textContent=`${c+1} / ${a}`,y){const r=a>1?c/(a-1):1;y.style.width=r*100+"%"}v&&v.classList.toggle("visible",c>0),e&&q()}function m(){c<a-1?l(c+1):I&&(location.href=I)}function f(){c>0?l(c-1):M&&(location.href=M+"#last")}function k(){return z+b}function T(){try{const t=localStorage.getItem(k());if(t)return JSON.parse(t)}catch{}return{lastChapter:"",chapters:{}}}function q(){const t=a>1?c/(a-1):1,e=T(),n=e.chapters[h]??{current:0,furthest:0};n.current=t,n.furthest=Math.max(n.furthest,t),e.chapters[h]=n,e.lastChapter=h;try{localStorage.setItem(k(),JSON.stringify(e))}catch{}}function R(){if(location.hash==="#last")return a-1;if(location.hash==="#resume"){const n=T().chapters[h];return n?Math.round(n.current*Math.max(1,a-1)):0}const t=location.hash.match(/^#page-(\d+)$/);if(t)return Math.max(0,parseInt(t[1],10)-1);try{const e=performance.getEntriesByType("navigation");if(e.length>0){const n=e[0];if(n.type==="reload"||n.type==="back_forward"){const o=T().chapters[h];if(o)return Math.round(o.current*Math.max(1,a-1))}}}catch{}return 0}function U(t){if(t.target.closest("a"))return;const n=t.clientX,r=window.innerWidth/3;n<r?f():m()}function W(t){const e=document.getElementById("settings-panel");if(!(e&&!e.hidden))switch(t.key){case"ArrowRight":case"PageDown":t.preventDefault(),m();break;case"ArrowLeft":case"PageUp":t.preventDefault(),f();break;case"Home":t.preventDefault(),l(0);break;case"End":t.preventDefault(),l(a-1);break}}function G(t){A=t.touches[0].clientX,x=t.touches[0].clientY}function Z(t){const e=t.changedTouches[0].clientX-A,n=t.changedTouches[0].clientY-x;Math.abs(e)>50&&Math.abs(e)>Math.abs(n)&&(e<0?m():f())}function Y(){p&&clearTimeout(p),p=setTimeout(()=>{const t=a>1?c/(a-1):0;s.style.transition="none",s.style.transform="translateX(0)",_(),s.offsetHeight,requestAnimationFrame(()=>{L();const e=Math.round(t*(a-1));l(e,!1),requestAnimationFrame(()=>{s.style.transition=""})})},250)}function $(){try{const t=localStorage.getItem(P);if(t){const e=JSON.parse(t);return{fontSize:Math.max(7,Math.min(24,e.fontSize??18)),theme:["light","sepia","dark"].includes(e.theme)?e.theme:"light"}}}catch{}return{fontSize:18,theme:"light"}}function E(t){try{localStorage.setItem(P,JSON.stringify(t))}catch{}}function B(t){const e=document.documentElement;e.classList.remove("theme-light","theme-sepia","theme-dark"),t!=="light"&&e.classList.add(`theme-${t}`),document.querySelectorAll(".theme-btn").forEach(n=>{n.classList.toggle("active",n.dataset.theme===t)})}function S(t){document.documentElement.style.fontSize=t+"px";const e=document.getElementById("font-label");e&&(e.textContent=Math.round(t/18*100)+"%")}function J(){const t=document.getElementById("settings-toggle"),e=document.getElementById("settings-panel"),n=document.getElementById("font-down"),r=document.getElementById("font-up");if(!t||!e||!n||!r)return;const o=$();B(o.theme),S(o.fontSize),t.addEventListener("click",i=>{i.stopPropagation();const u=!e.hidden;e.hidden=u,t.setAttribute("aria-expanded",String(!u))}),document.addEventListener("click",i=>{!e.hidden&&!e.contains(i.target)&&i.target!==t&&(e.hidden=!0,t.setAttribute("aria-expanded","false"))}),n.addEventListener("click",i=>{i.stopPropagation(),o.fontSize=Math.max(7,o.fontSize-1),S(o.fontSize),E(o),N()}),r.addEventListener("click",i=>{i.stopPropagation(),o.fontSize=Math.min(24,o.fontSize+1),S(o.fontSize),E(o),N()}),document.querySelectorAll(".theme-btn").forEach(i=>{i.addEventListener("click",u=>{u.stopPropagation(),o.theme=i.dataset.theme,B(o.theme),E(o)})})}function N(){const t=a>1?c/(a-1):0;s.style.transition="none",s.style.transform="translateX(0)",_(),s.offsetHeight,requestAnimationFrame(()=>{L();const e=Math.round(t*(a-1));l(e,!1),requestAnimationFrame(()=>{s.style.transition=""})})}function O(){const t=document.getElementById("pager-viewport"),e=document.getElementById("chapter-body"),n=document.getElementById("page-counter"),r=document.getElementById("reader");!t||!e||!n||!r||(d=t,s=e,F=n,y=document.getElementById("progress-bar"),v=document.getElementById("running-header"),b=r.dataset.bookSlug??"",h=r.dataset.chapterSlug??"",M=r.dataset.prevChapter??"",I=r.dataset.nextChapter??"",document.documentElement.classList.add("paged-mode"),J(),s.style.transition="none",_(),requestAnimationFrame(()=>{L();const o=R();l(Math.min(o,a-1),o>0),requestAnimationFrame(()=>{s.style.transition=""}),d.addEventListener("click",U),document.addEventListener("keydown",W),d.addEventListener("touchstart",G,{passive:!0}),d.addEventListener("touchend",Z,{passive:!0}),window.addEventListener("resize",Y),document.getElementById("page-prev")?.addEventListener("click",f),document.getElementById("page-next")?.addEventListener("click",m)}))}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",O):O();
